# =============================================================================
# TMUX CONFIGURATION - Low Latency / Neovim-centric
# =============================================================================

##### CORE SETTINGS & PERFORMANCE #####

set -g mouse on
set -g default-terminal "tmux-256color"
# Use generic truecolor override instead of ",alacritty:RGB"
set -ag terminal-overrides ",*:Tc"

set -sg escape-time 10
set -g focus-events on
setw -g mode-keys vi

set -g base-index 1
setw -g pane-base-index 1
set -g renumber-windows on

# Reasonable scrollback without making tmux manage megabytes per pane
set -g history-limit 10000

# Avoid tmux doing fancy renames / title juggling that triggers redraws
set -g allow-rename off
set -g set-titles off
set -g set-titles-string ""


##### NEOVIM-AWARE PANE NAVIGATION #####
# Keep this. It's good and doesn't really cost perf.

vim_pattern='(\S+/)?g?\.?(view|l?n?vim?x?|fzf)(diff)?(-wrapped)?'
is_vim="ps -o state= -o comm= -t '#{pane_tty}' \
    | grep -iqE '^[^TXZ ]+ +${vim_pattern}$'"

bind -n C-h if-shell "$is_vim" 'send-keys C-h'  'select-pane -L'
bind -n C-j if-shell "$is_vim" 'send-keys C-j'  'select-pane -D'
bind -n C-k if-shell "$is_vim" 'send-keys C-k'  'select-pane -U'
bind -n C-l if-shell "$is_vim" 'send-keys C-l'  'select-pane -R'

bind -T copy-mode-vi C-h select-pane -L
bind -T copy-mode-vi C-j select-pane -D
bind -T copy-mode-vi C-k select-pane -U
bind -T copy-mode-vi C-l select-pane -R


##### CLIPBOARD (WSL â†” Windows) #####
# Keep all of this; it's cheap and very useful.

bind v copy-mode
bind -T copy-mode-vi v send -X begin-selection
bind -T copy-mode-vi C-v send -X rectangle-toggle

# Copy to Windows clipboard
bind -T copy-mode-vi y     send -X copy-pipe-and-cancel "win32yank.exe -i --crlf"
bind -T copy-mode-vi Enter send -X copy-pipe-and-cancel "win32yank.exe -i --crlf"
bind -T copy-mode-vi MouseDragEnd1Pane send -X copy-pipe-and-cancel "win32yank.exe -i --crlf"

# Paste from Windows clipboard
bind p run "win32yank.exe -o --lf | tmux load-buffer - ; tmux paste-buffer"
bind C-p run "win32yank.exe -o --lf | tmux load-buffer - ; tmux paste-buffer"


##### SESSION / WINDOW / PANE WORKFLOW #####
# Keep your muscle memory, not the bling.

# Sessions
bind S new-session -c "#{pane_current_path}"
bind s choose-session -Z
bind K confirm-before -p "Kill session #S? (y/n)" kill-session
bind R command-prompt -I "#S" "rename-session '%%'"

# Project template launcher
bind P command-prompt -p "Project name:" \
    "new-session -d -s '%%' -c '~/projects/%%'; \
     new-window -t '%%':2 -n 'editor' -c '~/projects/%%'; \
     new-window -t '%%':3 -n 'server' -c '~/projects/%%'; \
     new-window -t '%%':4 -n 'logs' -c '~/projects/%%'; \
     select-window -t '%%':1; \
     switch-client -t '%%'"

# Windows
bind c new-window -c "#{pane_current_path}"
bind W command-prompt -I "#W" "rename-window '%%'"
bind h previous-window
bind l next-window
bind b last-window

# Panes
bind | split-window -h -c "#{pane_current_path}"
bind - split-window -v -c "#{pane_current_path}"
bind x kill-pane
bind z resize-pane -Z
bind r rotate-window

# Quick layouts
bind -n M-1 select-layout even-horizontal
bind -n M-2 select-layout even-vertical
bind -n M-3 select-layout main-horizontal
bind -n M-4 select-layout main-vertical
bind -n M-5 select-layout tiled

setw -g aggressive-resize on


##### STATUS LINE / APPEARANCE #####
# Goal: minimal, static, predictable.
# We remove Dracula/powerline/widgets because they run shell commands and update constantly.

# Update every 5 seconds max (not every keypress)
set -g status-interval 5

# Simple bar, no fancy plugin, no shell commands like #(uptime)
set -g status on
set -g status-position bottom
set -g status-justify left
set -g status-style "bg=#000000,fg=#bbbbbb"

# Just session name on the left
set -g status-left "#S "
set -g status-left-length 20

# Just host on the right
set -g status-right "#H "
set -g status-right-length 20

# Window titles in the middle, lightweight formatting
set-window-option -g window-status-format "#[fg=#bbbbbb,bg=#000000] #I:#W "
set-window-option -g window-status-current-format "#[fg=#000000,bg=#bbbbbb,bold] #I:#W "

# BORDERS:
# We DO NOT use pane-border-format or pane-border-status.
# They force tmux to rerender borders (which = flicker/latency in Neovim).
set -g pane-border-style 'fg=#44475a'
set -g pane-active-border-style 'fg=#ffffff,bold'
set -g pane-border-format ""
set -g pane-border-status off

# Don't dim inactive panes using window-active-style/pane-active-style tricks;
# constant palette swapping = constant redraw. Just leave default.
set -g window-active-style "fg=default,bg=default"
set -g window-style "fg=default,bg=default"


##### SILENCE EXTRA REDRAWS #####

# Don't flash or vibrate the UI on bell/activity
set -g bell-action none
set -g monitor-activity off
setw -g monitor-activity off


##### PLUGINS (TPM) #####
# We kill most plugins that constantly touch statusline or run background loops.
# We keep TPM itself (so you still CAN load plugins), navigator (already inlined),
# and resurrect/continuum (these are OK, they don't repaint per keystroke).

set -g @plugin 'tmux-plugins/tpm'
set -g @plugin 'tmux-plugins/tmux-sensible'

# KEEP persistence because it's actually useful and mostly idle.
set -g @plugin 'tmux-plugins/tmux-resurrect'
set -g @plugin 'tmux-plugins/tmux-continuum'

# DROP these:
# - dracula/tmux (powerline, cpu/ram widgets force constant status redraws)
# - joshmedeski/tmux-nerd-font-window-name (dynamic nerd icons = status churn)
# - christoomey/vim-tmux-navigator (we already inlined equivalent bindings)
# - kdheepak/lazygit.nvim (this is a Neovim plugin, not a tmux plugin; not needed here)

# tmux-resurrect / continuum config
set -g @resurrect-capture-pane-contents 'on'
set -g @resurrect-strategy-nvim 'session'
set -g @resurrect-dir '~/.tmux/resurrect'
set -g @continuum-automatic-restore 'on'
set -g @continuum-save-interval '15'

# Lazygit popup is fine: it's on-demand, not constantly drawing
bind g popup -d '#{pane_current_path}' -xC -yC -w80% -h80% -E lazygit
bind G new-window -n lazygit -c '#{pane_current_path}' lazygit

# TPM init at the bottom
run -b '~/.tmux/plugins/tpm/tpm'
